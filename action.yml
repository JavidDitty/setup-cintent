name: "Setup CIntent"
description: "Set up your GitHub Actions job for CIntent."
author: "Javid Ditty"
branding:
  icon: "eye"
  color: "orange"
runs:
  using: "composite"
  steps:
    - name: Install Dependencies
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        sudo pip install black flake8 mypy py-spy pylint pytest ruff tox uv
        pip install black flake8 mypy py-spy pylint pytest ruff tox uv

    - name: Set Environmental Variables
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        CINTENT_ARTIFACT_NAME="cintent_log"
        echo "CINTENT_ARTIFACT_NAME=$CINTENT_ARTIFACT_NAME" >> $GITHUB_ENV

        CINTENT_BASH=/home/runner/cintent/bin/bash
        echo "CINTENT_BASH=$CINTENT_BASH" >> $GITHUB_ENV

        CINTENT_BIN=/home/runner/cintent/bin
        echo "CINTENT_BIN=$CINTENT_BIN" >> $GITHUB_ENV
        mkdir -p $CINTENT_BIN

        CINTENT_BLACK=/home/runner/cintent/bin/black
        echo "CINTENT_BLACK=$CINTENT_BLACK" >> $GITHUB_ENV

        CINTENT_FLAKE8=/home/runner/cintent/bin/flake8
        echo "CINTENT_FLAKE8=$CINTENT_FLAKE8" >> $GITHUB_ENV

        CINTENT_LOGS=/home/runner/cintent/log
        echo "CINTENT_LOGS=$CINTENT_LOGS" >> $GITHUB_ENV
        mkdir -p $CINTENT_LOGS

        CINTENT_MYPY=/home/runner/cintent/bin/mypy
        echo "CINTENT_MYPY=$CINTENT_MYPY" >> $GITHUB_ENV

        CINTENT_PY=/home/runner/cintent/bin/python
        echo "CINTENT_PY=$CINTENT_PY" >> $GITHUB_ENV

        CINTENT_PY_BIN=$(which python)
        echo "CINTENT_PY_BIN=$CINTENT_PY_BIN" >> $GITHUB_ENV

        CINTENT_PY3=/home/runner/cintent/bin/python3
        echo "CINTENT_PY3=$CINTENT_PY3" >> $GITHUB_ENV

        CINTENT_PY3_BIN=$(which python3)
        echo "CINTENT_PY3_BIN=$CINTENT_PY3_BIN" >> $GITHUB_ENV

        CINTENT_PYLINT=/home/runner/cintent/bin/pylint
        echo "CINTENT_PYLINT=$CINTENT_PYLINT" >> $GITHUB_ENV

        CINTENT_PYTEST=/home/runner/cintent/bin/pytest
        echo "CINTENT_PYTEST=$CINTENT_PYTEST" >> $GITHUB_ENV

        CINTENT_RUFF=/home/runner/cintent/bin/ruff
        echo "CINTENT_RUFF=$CINTENT_RUFF" >> $GITHUB_ENV

        CINTENT_STEP_ID=0
        echo "CINTENT_STEP_ID=$CINTENT_STEP_ID" >> $GITHUB_ENV

        CINTENT_TEMP=/home/runner/cintent/temp
        echo "CINTENT_TEMP=$CINTENT_TEMP" >> $GITHUB_ENV
        mkdir -p $CINTENT_TEMP

        CINTENT_TOX=/home/runner/cintent/bin/tox
        echo "CINTENT_TOX=$CINTENT_TOX" >> $GITHUB_ENV

        CINTENT_UV=/home/runner/cintent/bin/uv
        echo "CINTENT_UV=$CINTENT_UV" >> $GITHUB_ENV

    - name: Write the 'bash' Wrapper
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        # Save the current matrix configurations
        echo "${{ toJson(matrix) }}" > matrix_context.json
        CINTENT_MATRIX=$(cat matrix_context.json | tr -s '\n' ' ')
        echo "CINTENT_MATRIX=$CINTENT_MATRIX" >> $GITHUB_ENV

        # Write the bash wrapper
        cat << 'WRAPPER_EOF' > ${{ env.CINTENT_BASH }}
        #!/bin/bash
        if [[ -z "${CINTENT_IS_TRACING_BASH}" ]]; then
          export CINTENT_IS_TRACING_BASH=true
          echo "CINTENT_IS_TRACING_BASH=$CINTENT_IS_TRACING_BASH" >> $GITHUB_ENV
          CINTENT_STEP_ID=$((CINTENT_STEP_ID+1))
          echo "CINTENT_STEP_ID=$CINTENT_STEP_ID" >> "$GITHUB_ENV"
          
          # Define the log paths
          timestamp=$(date +%s%N)
          metadata_log=$CINTENT_LOGS/$timestamp.$CINTENT_STEP_ID.metadata.txt
          execsnoop_log=$CINTENT_LOGS/$timestamp.$CINTENT_STEP_ID.execsnoop.txt
          opensnoop_log=$CINTENT_LOGS/$timestamp.$CINTENT_STEP_ID.opensnoop.txt
          
          # Create the metadata log
          echo -en \
          "repository = $GITHUB_REPOSITORY\n"\
          "branch = $GITHUB_REF_NAME\n"\
          "commit = $GITHUB_SHA\n"\
          "workflow = ${GITHUB_WORKFLOW_REF%@*}\n"\
          "run_number = $GITHUB_RUN_NUMBER\n"\
          "run_attempt = $GITHUB_RUN_ATTEMPT\n"\
          "workspace = $GITHUB_WORKSPACE\n"\
          "job_id = $GITHUB_JOB\n"\
          "matrix = $CINTENT_MATRIX\n"\
          "step_id = $CINTENT_STEP_ID\n"\
          > "$metadata_log"
          sed -i 's/^[ ]*//' "$metadata_log"

          # Start snooping tools and pipe their outputs to their logs
          sudo execsnoop-bpfcc -qtx > "$execsnoop_log" 2> /dev/null &
          sudo opensnoop-bpfcc -eT -n python > "$opensnoop_log" 2> /dev/null &
      
          # Wait for snooping tools to start tracing (or timeout)
          timeout_time=60
          start_time=$SECONDS
          current_time=$((SECONDS - start_time))

          execsnoop_search="TIME(s)\s+PCOMM\s+PID\s+PPID\s+RET\s+ARGS"
          opensnoop_search="TIME(s)\s+PID\s+COMM\s+FD\s+ERR\s+FLAGS\s+PATH"
          until grep -q "$execsnoop_search" "$execsnoop_log" && grep -q "$opensnoop_search" "$opensnoop_log" || [[ "$current_time" -gt "$timeout_time" ]]; do
            sleep 1
            current_time=$((SECONDS - start_time))
          done
          if grep -q "$execsnoop_search" "$execsnoop_log"; then
            echo "execsnoop failed to start!" 1>&2
            exit 1
          fi
          if grep -q "$opensnoop_search" "$opensnoop_log"; then
            echo "opensnoop failed to start!" 1>&2
            exit 1
          fi

          # Start the bash script
          echo "start_time = $(date +%s)" >> $metadata_log
          /bin/bash "$@"
          echo "end_time = $(date +%s)" >> $metadata_log
          unset CINTENT_IS_TRACING_BASH
          echo "CINTENT_IS_TRACING_BASH=" >> $GITHUB_ENV
        else
          /bin/bash "$@"
        fi
        WRAPPER_EOF
        chmod +x ${{ env.CINTENT_BASH }}

    - name: Write the 'black' Wrapper
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        cat << 'WRAPPER_EOF' > ${{ env.CINTENT_BLACK }}
        #!/bin/bash
        log_path="$CINTENT_LOGS/$(date +%s%N).$CINTENT_STEP_ID.pyisession.json"
        sudo py-spy record --format speedscope --full-filenames --function --output "$log_path" --subprocesses -- python3 -m black "$@"
        WRAPPER_EOF
        sudo chmod +x ${{ env.CINTENT_BLACK }}

    - name: Write the 'flake8' Wrapper
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        cat << 'WRAPPER_EOF' > ${{ env.CINTENT_FLAKE8 }}
        #!/bin/bash
        log_path="$CINTENT_LOGS/$(date +%s%N).$CINTENT_STEP_ID.pyisession.json"
        sudo py-spy record --format speedscope --full-filenames --function --output "$log_path" --subprocesses -- python3 -m flake8 "$@"
        WRAPPER_EOF
        sudo chmod +x ${{ env.CINTENT_FLAKE8 }}

    - name: Write the 'mypy' Wrapper
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        cat << 'WRAPPER_EOF' > ${{ env.CINTENT_MYPY }}
        #!/bin/bash
        log_path="$CINTENT_LOGS/$(date +%s%N).$CINTENT_STEP_ID.pyisession.json"
        sudo py-spy record --format speedscope --full-filenames --function --output "$log_path" --subprocesses -- python3 -m mypy "$@"
        WRAPPER_EOF
        sudo chmod +x ${{ env.CINTENT_MYPY }}

    - name: Write the 'pylint' Wrapper
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        cat << 'WRAPPER_EOF' > ${{ env.CINTENT_PYLINT }}
        #!/bin/bash
        log_path="$CINTENT_LOGS/$(date +%s%N).$CINTENT_STEP_ID.pyisession.json"
        sudo py-spy record --format speedscope --full-filenames --function --output "$log_path" --subprocesses -- python3 -m pylint "$@"
        WRAPPER_EOF
        sudo chmod +x ${{ env.CINTENT_PYLINT }}

    - name: Write the 'pytest' Wrapper
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        cat << 'WRAPPER_EOF' > ${{ env.CINTENT_PYTEST }}
        #!/bin/bash
        log_path="$CINTENT_LOGS/$(date +%s%N).$CINTENT_STEP_ID.pyisession.json"
        sudo py-spy record --format speedscope --full-filenames --function --output "$log_path" --subprocesses -- python3 -m pytest "$@"
        WRAPPER_EOF
        sudo chmod +x ${{ env.CINTENT_PYTEST }}

    - name: Write the 'python' Wrapper
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        cat << 'WRAPPER_EOF' > ${{ env.CINTENT_PY }}
        #!/bin/bash
        log_path="$CINTENT_LOGS/$(date +%s%N).$CINTENT_STEP_ID.pyisession.json"
        sudo py-spy record --format speedscope --full-filenames --function --output "$log_path" --subprocesses -- $CINTENT_PY_BIN "$@"
        WRAPPER_EOF
        sudo chmod +x ${{ env.CINTENT_PY }}

    - name: Write the 'python3' Wrapper
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        cat << 'WRAPPER_EOF' > ${{ env.CINTENT_PY3 }}
        #!/bin/bash
        log_path="$CINTENT_LOGS/$(date +%s%N).$CINTENT_STEP_ID.pyisession.json"
        sudo py-spy record --format speedscope --full-filenames --function --output "$log_path" --subprocesses -- $CINTENT_PY3_BIN "$@"
        WRAPPER_EOF
        sudo chmod +x ${{ env.CINTENT_PY3 }}

    - name: Write the 'ruff' Wrapper
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        cat << 'WRAPPER_EOF' > ${{ env.CINTENT_RUFF }}
        #!/bin/bash
        log_path="$CINTENT_LOGS/$(date +%s%N).$CINTENT_STEP_ID.pyisession.json"
        sudo py-spy record --format speedscope --full-filenames --function --output "$log_path" --subprocesses -- python3 -m ruff "$@"
        WRAPPER_EOF
        sudo chmod +x ${{ env.CINTENT_RUFF }}

    - name: Write the 'tox' Wrapper
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        cat << 'WRAPPER_EOF' > ${{ env.CINTENT_TOX }}
        #!/bin/bash
        log_path="$CINTENT_LOGS/$(date +%s%N).$CINTENT_STEP_ID.pyisession.json"
        sudo py-spy record --format speedscope --full-filenames --function --output "$log_path" --subprocesses -- python3 -m tox "$@"
        WRAPPER_EOF
        sudo chmod +x ${{ env.CINTENT_TOX }}

    - name: Write the 'uv' Wrapper
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        cat << 'WRAPPER_EOF' > ${{ env.CINTENT_UV }}
        #!/bin/bash
        log_path="$CINTENT_LOGS/$(date +%s%N).$CINTENT_STEP_ID.pyisession.json"
        sudo py-spy record --format speedscope --full-filenames --function --output "$log_path" --subprocesses -- python3 -m uv "$@"
        WRAPPER_EOF
        sudo chmod +x ${{ env.CINTENT_UV }}

    - name: Write the 'python3' Wrapper
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        echo ${{ env.CINTENT_BIN }} >> $GITHUB_PATH
